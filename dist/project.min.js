(function(w){var r=function(a){this.options=a||{};this.projectedleft=this.options.projectedleft||0;this.projectedtop=this.options.projectedtop||0;this.projectedwidth=this.options.projectedwidth||100;this.projectedheight=this.options.projectedheight||100;this.flatleft=this.options.flatleft||0;this.flattop=this.options.flattop||0;this.flatwidth=this.options.flatwidth||100;this.flatheight=this.options.flatheight||100;this.projectedCorner=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];this.projectedCorner=
[{x:this.projectedleft+0,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+this.projectedheight},{x:this.projectedleft+0,y:this.projectedtop+this.projectedheight}];this.matrix=[[1,0,0],[0,1,0],[0,0,1]];this.invmatrix=[[1,0,0],[0,1,0],[0,0,1]];this.update()};r.prototype.getProjectedCornerBounds=function(){for(var a={left:99999,top:99999,right:-99999,bottom:-99999},b=0;4>b;b++)this.projectedCorner[b].x<
a.left&&(a.left=this.projectedCorner[b].x),this.projectedCorner[b].x>a.right&&(a.right=this.projectedCorner[b].x),this.projectedCorner[b].y<a.top&&(a.top=this.projectedCorner[b].y),this.projectedCorner[b].y>a.bottom&&(a.bottom=this.projectedCorner[b].y);a.width=a.right-a.left;a.height=a.bottom-a.top;return a};r.prototype.update=function(){function a(a,b){return k[a][b]}var b=1,c=1,e=0,f=0,b=this.projectedwidth/2,c=this.projectedheight/2,f=e=0,g=(this.projectedCorner[0].x-e)/b-1,d=(this.projectedCorner[0].y-
f)/c-1,h=(this.projectedCorner[1].x-e)/b-1,j=(this.projectedCorner[1].y-f)/c-1,l=(this.projectedCorner[3].x-e)/b-1,m=(this.projectedCorner[3].y-f)/c-1,b=(this.projectedCorner[2].x-e)/b-1,p=(this.projectedCorner[2].y-f)/c-1;console.log(g,d);console.log(h,j);console.log(l,m);console.log(b,p);var k=[[0,0,0],[0,0,0],[0,0,0]],u,s,n,c=h-b,f=l-b,e=g-h+b-l;u=j-p;s=m-p;n=d-j+p-m;0==e&&0==n?(k[0][0]=h-g,k[0][1]=b-h,k[0][2]=g,k[1][0]=j-d,k[1][1]=p-j,k[1][2]=d,k[2][0]=0,k[2][1]=0):(b=c*s-u*f,k[2][0]=0==b?1:(e*
s-n*f)/b,k[2][1]=0==b?1:(c*n-u*e)/b,k[0][0]=h-g+k[2][0]*h,k[0][1]=l-g+k[2][1]*l,k[0][2]=g,k[1][0]=j-d+k[2][0]*j,k[1][1]=m-d+k[2][1]*m,k[1][2]=d);k[2][2]=1;console.log("projection matrix",JSON.stringify(k));this.matrix=k;d=1/(+a(0,0)*(a(1,1)*a(2,2)-a(2,1)*a(1,2))-a(0,1)*(a(1,0)*a(2,2)-a(1,2)*a(2,0))+a(0,2)*(a(1,0)*a(2,1)-a(1,1)*a(2,0)));g=[[0,0,0],[0,0,0],[0,0,0]];h=(a(1,1)*a(2,2)-a(2,1)*a(1,2))*d;g[0][0]=h;h=-(a(0,1)*a(2,2)-a(0,2)*a(2,1))*d;g[0][1]=h;h=(a(0,1)*a(1,2)-a(0,2)*a(1,1))*d;g[0][2]=h;h=
-(a(1,0)*a(2,2)-a(1,2)*a(2,0))*d;g[1][0]=h;h=(a(0,0)*a(2,2)-a(0,2)*a(2,0))*d;g[1][1]=h;h=-(a(0,0)*a(1,2)-a(1,0)*a(0,2))*d;g[1][2]=h;h=(a(1,0)*a(2,1)-a(2,0)*a(1,1))*d;g[2][0]=h;h=-(a(0,0)*a(2,1)-a(2,0)*a(0,1))*d;g[2][1]=h;d*=a(0,0)*a(1,1)-a(1,0)*a(0,1);g[2][2]=d;console.log("inverted matrix",JSON.stringify(g));this.invmatrix=g};r.prototype.projectedToFlat=function(a,b){var c=this.invmatrix,e=0*this.projectedleft+0.5*this.projectedwidth,f=0*this.projectedtop+0.5*this.projectedheight,e=(a-1*e)/e,f=(b-
1*f)/f,g=c[2][0]*e+c[2][1]*f+c[2][2];return{x:this.flatwidth/1*(c[0][0]*e+c[0][1]*f+c[0][2])/g,y:this.flatheight/1*(c[1][0]*e+c[1][1]*f+c[1][2])/g}};r.prototype.flatToProjected=function(a,b){var c=this.matrix,e=this.projectedwidth/2,f=this.projectedheight/2,g=this.flatwidth/1,d=this.flatheight/1,g=(a-0*g)/g,d=(b-0*d)/d,h=c[2][0]*g+c[2][1]*d+c[2][2];return{x:e+e*(c[0][0]*g+c[0][1]*d+c[0][2])/h,y:f+f*(c[1][0]*g+c[1][1]*d+c[1][2])/h}};var n=function(a){a=a||{};this.projection=a.projection||null;this.projected=
a.projected||null;this.flat=a.flat||null;this.flatleft=a.flatleft||0;this.flattop=a.flattop||0;this.flatwidth=a.flatwidth||128;this.flatheight=a.flatheight||128;this.buffer=a.buffer||null;if(a.bufferwidth||a.bufferheight)this.bufferwidth=a.bufferwidth||128,this.bufferheight=a.bufferheight||128,this.bufferelement=document.createElement("canvas"),this.bufferelement.width=this.bufferwidth,this.bufferelement.height=this.bufferheight,this.buffer=this.bufferelement.getContext("2d"),a.bufferdebug&&document.body.appendChild(this.bufferelement);
null!=this.buffer&&(this.projection.flatwidth=this.bufferwidth,this.projection.flatheight=this.bufferheight,this.projection.update())};n.prototype.drawProjected=function(a){var b=this.projection;a=a||this.projected;var c=b.getProjectedCornerBounds();if(null!=this.buffer){this.buffer.clearRect(0,0,this.bufferwidth,this.bufferheight);this.buffer.drawImage(this.flat,this.flatleft,this.flattop,this.flatwidth,this.flatheight,0,0,this.bufferwidth,this.bufferheight);for(var e=this.buffer.getImageData(0,
0,this.bufferwidth,this.bufferheight),f=a.getImageData(0,0,b.projectedwidth,b.projectedheight),g=1,d=c.top;d<=c.bottom;d+=g)for(var h=c.left;h<=c.right;h+=g){var j=b.projectedToFlat(h,d),l=Math.round(j.x),m=Math.round(j.y),j=4*(d*b.projectedwidth+h);0<=l&&(0<=m&&l<this.bufferwidth&&m<this.bufferheight)&&(l=4*(m*this.bufferwidth+l),f.data[j+0]=e.data[l+0],f.data[j+1]=e.data[l+1],f.data[j+2]=e.data[l+2],f.data[j+3]=e.data[l+3])}}else{e=this.flat.getImageData(0,0,b.flatwidth,b.flatheight);f=a.getImageData(0,
0,b.projectedwidth,b.projectedheight);g=1;for(d=c.top;d<=c.bottom;d+=g)for(h=c.left;h<=c.right;h+=g)j=b.projectedToFlat(h,d),l=Math.round(j.x),m=Math.round(j.y),j=4*(d*b.projectedwidth+h),0<=l&&(0<=m&&l<b.flatwidth&&m<b.flatheight)&&(l=4*(m*b.flatwidth+l),f.data[j+0]=e.data[l+0],f.data[j+1]=e.data[l+1],f.data[j+2]=e.data[l+2],f.data[j+3]=e.data[l+3])}a.putImageData(f,0,0)};n.prototype.drawFlat=function(a){var b=this.projection;a=a||this.flat;a.clearRect(0,0,b.flatwidth,b.flatheight);for(var c=this.projected.getImageData(0,
0,b.projectedwidth,b.projectedheight),e=a.getImageData(0,0,b.flatwidth,b.flatheight),f=0;f<b.flatheight;f+=1)for(var g=0;g<b.flatwidth;g+=1){var d=b.flatToProjected(g,f),h=Math.round(d.x),j=Math.round(d.y),d=4*(f*b.flatwidth+g);0<=h&&(0<=j&&h<b.projectedwidth&&j<b.projectedheight)&&(h=4*(j*b.projectedwidth+h),e.data[d+0]=c.data[h+0],e.data[d+1]=c.data[h+1],e.data[d+2]=c.data[h+2],e.data[d+3]=c.data[h+3])}a.putImageData(e,0,0)};n.prototype.cross=function(a,b,c,e,f){a.lineWidth=f;a.beginPath();a.moveTo(b,
c-e);a.lineTo(b,c+e);a.moveTo(b-e,c);a.lineTo(b+e,c);a.closePath();a.stroke()};n.prototype.drawProjectedDebug=function(a,b){"undefined"===typeof b&&(b=-1);for(var c=0;4>c;c++)a.strokeStyle=c==b?"#ff0":"#f0f",this.cross(a,this.projection.projectedCorner[c].x,this.projection.projectedCorner[c].y,10,3);a.lineWidth=1;a.strokeStyle="#f0f";for(c=0;4>=c;c++){var e=c*this.projection.flatwidth/4,f=c*this.projection.flatheight/4,g=this.projection.flatToProjected(e,0),e=this.projection.flatToProjected(e,this.projection.flatheight),
d=this.projection.flatToProjected(0,f),f=this.projection.flatToProjected(this.projection.flatwidth,f);a.beginPath();a.moveTo(g.x,g.y);a.lineTo(e.x,e.y);a.moveTo(d.x,d.y);a.lineTo(f.x,f.y);a.closePath();a.stroke()}};n.prototype.drawFlatDebug=function(a){a.strokeStyle="#ff0";null!=this.buffer?(this.cross(a,this.flatleft,this.flattop,10,3),this.cross(a,this.flatleft+this.flatwidth,this.flattop,10,3),this.cross(a,this.flatleft+this.flatwidth,this.flattop+this.flatheight,10,3),this.cross(a,this.flatleft,
this.flattop+this.flatheight,10,3)):(this.cross(a,this.projection.flatleft,this.projection.flattop,10,3),this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop,10,3),this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop+this.projection.flatheight,10,3),this.cross(a,this.projection.flatleft,this.projection.flattop+this.projection.flatheight,10,3))};glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?
WebGLFloatArray:Array;var t={identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},create:function(a){var b=new glMatrixArrayType(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b},ortho:function(a,b,c,e,f,g,d){d||(d=t.create());var h=b-a,j=e-c,l=g-f;d[0]=2/h;d[1]=0;
d[2]=0;d[3]=0;d[4]=0;d[5]=2/j;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=-2/l;d[11]=0;d[12]=-(a+b)/h;d[13]=-(e+c)/j;d[14]=-(g+f)/l;d[15]=1;return d}};window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)};WebGLUnwarp=function(a){this.projection=a.projection||null;this.projected=a.projected||null;this.flat=a.flat||null;this.flatleft=a.flatleft||
0;this.flattop=a.flattop||0;this.flatwidth=a.flatwidth||1;this.flatheight=a.flatheight||1;this.texture=a.texture||null;this.cubeVertexIndexBuffer=this.cubeVertexTextureCoordBuffer=this.cubeVertexPositionBuffer=null;this.allocated=!1;this.resolution=a.resolution||15};WebGLUnwarp.prototype.createFragmentShader=function(a){var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,"precision mediump float;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nvoid main(void) {\n\tgl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}");
a.compileShader(b);return!a.getShaderParameter(b,a.COMPILE_STATUS)?(alert(a.getShaderInfoLog(b)),null):b};WebGLUnwarp.prototype.createVertexShader=function(a){var b=a.createShader(a.VERTEX_SHADER);a.shaderSource(b,"attribute vec3 aVertexPosition;\nattribute vec2 aTextureCoord;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec2 vTextureCoord;\nvoid main(void) {\n\tgl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\n\tvTextureCoord = aTextureCoord;\n}");a.compileShader(b);
return!a.getShaderParameter(b,a.COMPILE_STATUS)?(alert(a.getShaderInfoLog(b)),null):b};WebGLUnwarp.prototype.mapuv=function(a,b){return{u:a*this.flatwidth+this.flatleft,v:b*this.flatheight+this.flattop}};WebGLUnwarp.prototype.drawProjected=function(){var a=this.projected,b=this.projection;if(!this.allocated){this.cubeVertexPositionBuffer=a.createBuffer();this.cubeVertexTextureCoordBuffer=a.createBuffer();this.cubeVertexIndexBuffer=a.createBuffer();this.shaderProgram=a.createProgram();a.attachShader(this.shaderProgram,
this.createVertexShader(a));a.attachShader(this.shaderProgram,this.createFragmentShader(a));a.linkProgram(this.shaderProgram);if(!a.getProgramParameter(this.shaderProgram,a.LINK_STATUS)){alert("Could not link the shader program!");return}this.vertexPositionAttribute=a.getAttribLocation(this.shaderProgram,"aVertexPosition");this.textureCoordAttribute=a.getAttribLocation(this.shaderProgram,"aTextureCoord");this.pMatrixUniform=a.getUniformLocation(this.shaderProgram,"uPMatrix");this.mvMatrixUniform=
a.getUniformLocation(this.shaderProgram,"uMVMatrix");this.samplerUniform=a.getUniformLocation(this.shaderProgram,"uSampler");this.allocated=!0}for(var c=[],e=[],f=[],g=0,d=this.resolution,h=this.resolution,j=0;j<h;j++)for(var l=0;l<d;l++){var m=l/d,p=j/h,k=(l+1)/d,n=(j+1)/h,s=this.projection.flatToProjected(100*m,100*p),q=this.projection.flatToProjected(100*k,100*p),r=this.projection.flatToProjected(100*k,100*n),v=this.projection.flatToProjected(100*m,100*n);c.push(s.x);c.push(s.y);c.push(0);c.push(q.x);
c.push(q.y);c.push(0);c.push(r.x);c.push(r.y);c.push(0);c.push(v.x);c.push(v.y);c.push(0);s=this.mapuv(m,1-p);p=this.mapuv(k,1-p);k=this.mapuv(k,1-n);m=this.mapuv(m,1-n);e.push(s.u);e.push(s.v);e.push(p.u);e.push(p.v);e.push(k.u);e.push(k.v);e.push(m.u);e.push(m.v);f.push(4*g+0);f.push(4*g+1);f.push(4*g+2);f.push(4*g+0);f.push(4*g+2);f.push(4*g+3);g++}a.useProgram(this.shaderProgram);a.enableVertexAttribArray(this.vertexPositionAttribute);a.enableVertexAttribArray(this.textureCoordAttribute);a.bindBuffer(a.ARRAY_BUFFER,
this.cubeVertexPositionBuffer);a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW);this.cubeVertexPositionBuffer.itemSize=3;this.cubeVertexPositionBuffer.numItems=c.length/1;a.bindBuffer(a.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer);a.bufferData(a.ARRAY_BUFFER,new Float32Array(e),a.STATIC_DRAW);this.cubeVertexTextureCoordBuffer.itemSize=2;this.cubeVertexTextureCoordBuffer.numItems=e.length/1;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);a.bufferData(a.ELEMENT_ARRAY_BUFFER,
new Uint16Array(f),a.STATIC_DRAW);this.cubeVertexIndexBuffer.itemSize=1;this.cubeVertexIndexBuffer.numItems=f.length/1;c=t.create();e=t.create();t.identity(e);t.ortho(0,b.projectedwidth,b.projectedheight,0,-1,1,e);t.identity(c);a.uniformMatrix4fv(this.pMatrixUniform,!1,e);a.uniformMatrix4fv(this.mvMatrixUniform,!1,c);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,this.texture);a.uniform1i(this.samplerUniform,0);a.bindBuffer(a.ARRAY_BUFFER,this.cubeVertexPositionBuffer);a.vertexAttribPointer(this.vertexPositionAttribute,
this.cubeVertexPositionBuffer.itemSize,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer);a.vertexAttribPointer(this.textureCoordAttribute,this.cubeVertexTextureCoordBuffer.itemSize,a.FLOAT,!1,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);a.drawElements(a.TRIANGLES,this.cubeVertexIndexBuffer.numItems,a.UNSIGNED_SHORT,0)};var q={};q.Unwarp=r;q.Warp=r;q.CanvasUnwarp=n;q.CanvasWarp=n;q.WebGLUnwarp=WebGLUnwarp;q.WebGLWarp=WebGLUnwarp;w.Project=q})(this);
