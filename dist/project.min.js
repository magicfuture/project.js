(function(s){var m=function(a){this.options=a||{};this.projectedleft=this.options.projectedleft||0;this.projectedtop=this.options.projectedtop||0;this.projectedstride=this.options.projectedstride||100;this.projectedwidth=this.options.projectedwidth||100;this.projectedheight=this.options.projectedheight||100;this.flatleft=this.options.flatleft||0;this.flattop=this.options.flattop||0;this.flatwidth=this.options.flatwidth||100;this.flatheight=this.options.flatheight||100;this.projectedCorner=[{x:0,y:0},
{x:0,y:0},{x:0,y:0},{x:0,y:0}];this.projectedCorner=[{x:this.projectedleft+0,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+this.projectedheight},{x:this.projectedleft+0,y:this.projectedtop+this.projectedheight}];this.matrix=[[1,0,0],[0,1,0],[0,0,1]];this.invmatrix=[[1,0,0],[0,1,0],[0,0,1]];this.update()};m.prototype.getProjectedCornerBounds=function(){for(var a={left:99999,top:99999,right:-99999,
bottom:-99999},b=0;4>b;b++)this.projectedCorner[b].x<a.left&&(a.left=this.projectedCorner[b].x),this.projectedCorner[b].x>a.right&&(a.right=this.projectedCorner[b].x),this.projectedCorner[b].y<a.top&&(a.top=this.projectedCorner[b].y),this.projectedCorner[b].y>a.bottom&&(a.bottom=this.projectedCorner[b].y);a.width=a.right-a.left;a.height=a.bottom-a.top;return a};m.prototype.update=function(){function a(a,b){return k[a][b]}var b=1,c=1,g=0,h=0,b=this.projectedwidth/2,c=this.projectedheight/2,h=g=0,d=
(this.projectedCorner[0].x-g)/b-1,e=(this.projectedCorner[0].y-h)/c-1,f=(this.projectedCorner[1].x-g)/b-1,j=(this.projectedCorner[1].y-h)/c-1,p=(this.projectedCorner[3].x-g)/b-1,l=(this.projectedCorner[3].y-h)/c-1,b=(this.projectedCorner[2].x-g)/b-1,m=(this.projectedCorner[2].y-h)/c-1;console.log(d,e);console.log(f,j);console.log(p,l);console.log(b,m);var k=[[0,0,0],[0,0,0],[0,0,0]],n,r,q,c=f-b,h=p-b,g=d-f+b-p;n=j-m;r=l-m;q=e-j+m-l;0==g&&0==q?(k[0][0]=f-d,k[0][1]=b-f,k[0][2]=d,k[1][0]=j-e,k[1][1]=
m-j,k[1][2]=e,k[2][0]=0,k[2][1]=0):(b=c*r-n*h,k[2][0]=0==b?1:(g*r-q*h)/b,k[2][1]=0==b?1:(c*q-n*g)/b,k[0][0]=f-d+k[2][0]*f,k[0][1]=p-d+k[2][1]*p,k[0][2]=d,k[1][0]=j-e+k[2][0]*j,k[1][1]=l-e+k[2][1]*l,k[1][2]=e);k[2][2]=1;console.log("projection matrix",JSON.stringify(k));this.matrix=k;e=1/(+a(0,0)*(a(1,1)*a(2,2)-a(2,1)*a(1,2))-a(0,1)*(a(1,0)*a(2,2)-a(1,2)*a(2,0))+a(0,2)*(a(1,0)*a(2,1)-a(1,1)*a(2,0)));d=[[0,0,0],[0,0,0],[0,0,0]];f=(a(1,1)*a(2,2)-a(2,1)*a(1,2))*e;d[0][0]=f;f=-(a(0,1)*a(2,2)-a(0,2)*a(2,
1))*e;d[0][1]=f;f=(a(0,1)*a(1,2)-a(0,2)*a(1,1))*e;d[0][2]=f;f=-(a(1,0)*a(2,2)-a(1,2)*a(2,0))*e;d[1][0]=f;f=(a(0,0)*a(2,2)-a(0,2)*a(2,0))*e;d[1][1]=f;f=-(a(0,0)*a(1,2)-a(1,0)*a(0,2))*e;d[1][2]=f;f=(a(1,0)*a(2,1)-a(2,0)*a(1,1))*e;d[2][0]=f;f=-(a(0,0)*a(2,1)-a(2,0)*a(0,1))*e;d[2][1]=f;e*=a(0,0)*a(1,1)-a(1,0)*a(0,1);d[2][2]=e;console.log("inverted matrix",JSON.stringify(d));this.invmatrix=d};m.prototype.projectedToFlat=function(a,b){var c=this.invmatrix,g=0*this.projectedleft+0.5*this.projectedwidth,
h=0*this.projectedtop+0.5*this.projectedheight,g=(a-1*g)/g,h=(b-1*h)/h,d=c[2][0]*g+c[2][1]*h+c[2][2];return{x:this.flatwidth/1*(c[0][0]*g+c[0][1]*h+c[0][2])/d,y:this.flatheight/1*(c[1][0]*g+c[1][1]*h+c[1][2])/d}};m.prototype.flatToProjected=function(a,b){var c=this.matrix,g=this.projectedwidth/2,h=this.projectedheight/2,d=this.flatwidth/1,e=this.flatheight/1,d=(a-0*d)/d,e=(b-0*e)/e,f=c[2][0]*d+c[2][1]*e+c[2][2];return{x:g+g*(c[0][0]*d+c[0][1]*e+c[0][2])/f,y:h+h*(c[1][0]*d+c[1][1]*e+c[1][2])/f}};var l=
function(a){a=a||{};this.projection=a.projection||null;this.projected=a.projected||null;this.flat=a.flat||null;this.flatleft=a.flatleft||0;this.flattop=a.flattop||0;this.flatwidth=a.flatwidth||128;this.flatheight=a.flatheight||128;this.buffer=a.buffer||null;if(a.bufferwidth||a.bufferheight)this.bufferwidth=a.bufferwidth||128,this.bufferheight=a.bufferheight||128,this.bufferelement=document.createElement("canvas"),this.bufferelement.width=this.bufferwidth,this.bufferelement.height=this.bufferheight,
this.buffer=this.bufferelement.getContext("2d"),a.bufferdebug&&document.body.appendChild(this.bufferelement);null!=this.buffer&&(this.projection.flatwidth=this.bufferwidth,this.projection.flatheight=this.bufferheight,this.projection.update())};l.prototype.drawProjected=function(){var a=this.projection,b=a.getProjectedCornerBounds();if(null!=this.buffer){this.buffer.clearRect(0,0,this.bufferwidth,this.bufferheight);this.buffer.drawImage(this.flat,this.flatleft,this.flattop,this.flatwidth,this.flatheight,
0,0,this.bufferwidth,this.bufferheight);for(var c=this.buffer.getImageData(0,0,this.bufferwidth,this.bufferheight),g=this.projected.getImageData(0,0,a.projectedwidth,a.projectedheight),h=1,d=b.top;d<=b.bottom;d+=h)for(var e=b.left;e<=b.right;e+=h){var f=a.projectedToFlat(e,d),j=Math.round(f.x),l=Math.round(f.y),f=4*(d*a.projectedwidth+e);0<=j&&(0<=l&&j<this.bufferwidth&&l<this.bufferheight)&&(j=4*(l*this.bufferwidth+j),g.data[f+0]=c.data[j+0],g.data[f+1]=c.data[j+1],g.data[f+2]=c.data[j+2],g.data[f+
3]=c.data[j+3])}}else{c=this.flat.getImageData(0,0,a.flatwidth,a.flatheight);g=this.projected.getImageData(0,0,a.projectedwidth,a.projectedheight);h=1;for(d=b.top;d<=b.bottom;d+=h)for(e=b.left;e<=b.right;e+=h)f=a.projectedToFlat(e,d),j=Math.round(f.x),l=Math.round(f.y),f=4*(d*a.projectedwidth+e),0<=j&&(0<=l&&j<a.flatwidth&&l<a.flatheight)&&(j=4*(l*a.flatwidth+j),g.data[f+0]=c.data[j+0],g.data[f+1]=c.data[j+1],g.data[f+2]=c.data[j+2],g.data[f+3]=c.data[j+3])}this.projected.putImageData(g,0,0)};l.prototype.drawFlat=
function(){var a=this.projection;this.flat.clearRect(0,0,a.flatwidth,a.flatheight);for(var b=this.projected.getImageData(0,0,a.projectedwidth,a.projectedheight),c=this.flat.getImageData(0,0,a.flatwidth,a.flatheight),g=0;g<a.flatheight;g+=1)for(var h=0;h<a.flatwidth;h+=1){var d=a.flatToProjected(h,g),e=Math.round(d.x),f=Math.round(d.y),d=4*(g*a.flatwidth+h);0<=e&&(0<=f&&e<a.projectedwidth&&f<a.projectedheight)&&(e=4*(f*a.projectedwidth+e),c.data[d+0]=b.data[e+0],c.data[d+1]=b.data[e+1],c.data[d+2]=
b.data[e+2],c.data[d+3]=b.data[e+3])}this.flat.putImageData(c,0,0)};l.prototype.cross=function(a,b,c,g,h){a.lineWidth=h;a.beginPath();a.moveTo(b,c-g);a.lineTo(b,c+g);a.moveTo(b-g,c);a.lineTo(b+g,c);a.closePath();a.stroke()};l.prototype.drawProjectedDebug=function(a){a.strokeStyle="#f0f";for(var b=0;4>b;b++)this.cross(a,this.projection.projectedCorner[b].x,this.projection.projectedCorner[b].y,10,3)};l.prototype.drawFlatDebug=function(a){a.strokeStyle="#ff0";null!=this.buffer?(this.cross(a,this.flatleft,
this.flattop,10,3),this.cross(a,this.flatleft+this.flatwidth,this.flattop,10,3),this.cross(a,this.flatleft+this.flatwidth,this.flattop+this.flatheight,10,3),this.cross(a,this.flatleft,this.flattop+this.flatheight,10,3)):(this.cross(a,this.projection.flatleft,this.projection.flattop,10,3),this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop,10,3),this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop+this.projection.flatheight,10,
3),this.cross(a,this.projection.flatleft,this.projection.flattop+this.projection.flatheight,10,3))};var n={};n.Unwarp=m;n.Warp=m;n.CanvasUnwarp=l;n.CanvasWarp=l;s.Project=n})(this);
