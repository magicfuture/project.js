(function(s){var l=function(a){this.options=a||{};this.projectedleft=this.options.projectedleft||0;this.projectedtop=this.options.projectedtop||0;this.projectedstride=this.options.projectedstride||100;this.projectedwidth=this.options.projectedwidth||100;this.projectedheight=this.options.projectedheight||100;this.flatleft=this.options.flatleft||0;this.flattop=this.options.flattop||0;this.flatwidth=this.options.flatwidth||100;this.flatheight=this.options.flatheight||100;this.projectedCorner=[{x:0,y:0},
{x:0,y:0},{x:0,y:0},{x:0,y:0}];this.projectedCorner=[{x:this.projectedleft+0,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+this.projectedheight},{x:this.projectedleft+0,y:this.projectedtop+this.projectedheight}];this.matrix=[[1,0,0],[0,1,0],[0,0,1]];this.invmatrix=[[1,0,0],[0,1,0],[0,0,1]];this.update()};l.prototype.getProjectedCornerBounds=function(){for(var a={left:99999,top:99999,right:-99999,
bottom:-99999},b=0;4>b;b++)this.projectedCorner[b].x<a.left&&(a.left=this.projectedCorner[b].x),this.projectedCorner[b].x>a.right&&(a.right=this.projectedCorner[b].x),this.projectedCorner[b].y<a.top&&(a.top=this.projectedCorner[b].y),this.projectedCorner[b].y>a.bottom&&(a.bottom=this.projectedCorner[b].y);a.width=a.right-a.left;a.height=a.bottom-a.top;return a};l.prototype.update=function(){function a(a,b){return j[a][b]}var b=1,c=1,g=0,h=0,b=this.projectedwidth/2,c=this.projectedheight/2,h=g=0,d=
(this.projectedCorner[0].x-g)/b-1,e=(this.projectedCorner[0].y-h)/c-1,f=(this.projectedCorner[1].x-g)/b-1,n=(this.projectedCorner[1].y-h)/c-1,k=(this.projectedCorner[3].x-g)/b-1,l=(this.projectedCorner[3].y-h)/c-1,b=(this.projectedCorner[2].x-g)/b-1,m=(this.projectedCorner[2].y-h)/c-1;console.log(d,e);console.log(f,n);console.log(k,l);console.log(b,m);var j=[[0,0,0],[0,0,0],[0,0,0]],q,r,p,c=f-b,h=k-b,g=d-f+b-k;q=n-m;r=l-m;p=e-n+m-l;0==g&&0==p?(j[0][0]=f-d,j[0][1]=b-f,j[0][2]=d,j[1][0]=n-e,j[1][1]=
m-n,j[1][2]=e,j[2][0]=0,j[2][1]=0):(b=c*r-q*h,j[2][0]=0==b?1:(g*r-p*h)/b,j[2][1]=0==b?1:(c*p-q*g)/b,j[0][0]=f-d+j[2][0]*f,j[0][1]=k-d+j[2][1]*k,j[0][2]=d,j[1][0]=n-e+j[2][0]*n,j[1][1]=l-e+j[2][1]*l,j[1][2]=e);j[2][2]=1;console.log("projection matrix",JSON.stringify(j));this.matrix=j;e=1/(+a(0,0)*(a(1,1)*a(2,2)-a(2,1)*a(1,2))-a(0,1)*(a(1,0)*a(2,2)-a(1,2)*a(2,0))+a(0,2)*(a(1,0)*a(2,1)-a(1,1)*a(2,0)));d=[[0,0,0],[0,0,0],[0,0,0]];f=(a(1,1)*a(2,2)-a(2,1)*a(1,2))*e;d[0][0]=f;f=-(a(0,1)*a(2,2)-a(0,2)*a(2,
1))*e;d[0][1]=f;f=(a(0,1)*a(1,2)-a(0,2)*a(1,1))*e;d[0][2]=f;f=-(a(1,0)*a(2,2)-a(1,2)*a(2,0))*e;d[1][0]=f;f=(a(0,0)*a(2,2)-a(0,2)*a(2,0))*e;d[1][1]=f;f=-(a(0,0)*a(1,2)-a(1,0)*a(0,2))*e;d[1][2]=f;f=(a(1,0)*a(2,1)-a(2,0)*a(1,1))*e;d[2][0]=f;f=-(a(0,0)*a(2,1)-a(2,0)*a(0,1))*e;d[2][1]=f;e*=a(0,0)*a(1,1)-a(1,0)*a(0,1);d[2][2]=e;console.log("inverted matrix",JSON.stringify(d));this.invmatrix=d};l.prototype.projectedToFlat=function(a,b){var c=this.invmatrix,g=0*this.projectedleft+0.5*this.projectedwidth,
h=0*this.projectedtop+0.5*this.projectedheight,g=(a-1*g)/g,h=(b-1*h)/h,d=c[2][0]*g+c[2][1]*h+c[2][2];return{x:this.flatwidth/1*(c[0][0]*g+c[0][1]*h+c[0][2])/d,y:this.flatheight/1*(c[1][0]*g+c[1][1]*h+c[1][2])/d}};l.prototype.flatToProjected=function(a,b){var c=this.matrix,g=this.projectedwidth/2,h=this.projectedheight/2,d=this.flatwidth/1,e=this.flatheight/1,d=(a-0*d)/d,e=(b-0*e)/e,f=c[2][0]*d+c[2][1]*e+c[2][2];return{x:g+g*(c[0][0]*d+c[0][1]*e+c[0][2])/f,y:h+h*(c[1][0]*d+c[1][1]*e+c[1][2])/f}};var k=
function(a){a=a||{};this.projection=a.projection||null;this.projected=a.projected||null;this.flat=a.flat||null};k.prototype.drawProjected=function(){for(var a=this.projection,b=a.getProjectedCornerBounds(),c=this.flat.getImageData(0,0,a.flatwidth,a.flatheight),g=this.projected.getImageData(0,0,a.projectedwidth,a.projectedheight),h=b.top;h<=b.bottom;h+=1)for(var d=b.left;d<=b.right;d+=1){var e=a.projectedToFlat(d,h),f=Math.round(e.x),k=Math.round(e.y),e=4*(h*a.projectedwidth+d);0<=f&&(0<=k&&f<a.flatwidth&&
k<a.flatheight)&&(f=4*(k*a.flatwidth+f),g.data[e+0]=c.data[f+0],g.data[e+1]=c.data[f+1],g.data[e+2]=c.data[f+2],g.data[e+3]=c.data[f+3])}this.projected.putImageData(g,0,0)};k.prototype.drawFlat=function(){var a=this.projection;this.flat.clearRect(0,0,a.flatwidth,a.flatheight);for(var b=this.projected.getImageData(0,0,a.projectedwidth,a.projectedheight),c=this.flat.getImageData(0,0,a.flatwidth,a.flatheight),g=0;g<a.flatheight;g+=1)for(var h=0;h<a.flatwidth;h+=1){var d=a.flatToProjected(h,g),e=Math.round(d.x),
f=Math.round(d.y),d=4*(g*a.flatwidth+h);0<=e&&(0<=f&&e<a.projectedwidth&&f<a.projectedheight)&&(e=4*(f*a.projectedwidth+e),c.data[d+0]=b.data[e+0],c.data[d+1]=b.data[e+1],c.data[d+2]=b.data[e+2],c.data[d+3]=b.data[e+3])}this.flat.putImageData(c,0,0)};k.prototype.cross=function(a,b,c,g,h){a.lineWidth=h;a.beginPath();a.moveTo(b,c-g);a.lineTo(b,c+g);a.moveTo(b-g,c);a.lineTo(b+g,c);a.closePath();a.stroke()};k.prototype.drawProjectedDebug=function(a){a.strokeStyle="#f0f";for(var b=0;4>b;b++)this.cross(a,
this.projection.projectedCorner[b].x,this.projection.projectedCorner[b].y,10,3)};k.prototype.drawFlatDebug=function(a){a.strokeStyle="#ff0";this.cross(a,this.projection.flatleft,this.projection.flattop,10,3);this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop,10,3);this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop+this.projection.flatheight,10,3);this.cross(a,this.projection.flatleft,this.projection.flattop+this.projection.flatheight,
10,3)};var m={};m.Unwarp=l;m.Warp=l;m.CanvasUnwarp=k;m.CanvasWarp=k;s.Project=m})(this);
