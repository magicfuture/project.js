(function(w){var r=function(a){this.options=a||{};this.projectedleft=this.options.projectedleft||0;this.projectedtop=this.options.projectedtop||0;this.projectedwidth=this.options.projectedwidth||100;this.projectedheight=this.options.projectedheight||100;this.flatleft=this.options.flatleft||0;this.flattop=this.options.flattop||0;this.flatwidth=this.options.flatwidth||100;this.flatheight=this.options.flatheight||100;this.projectedCorner=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];this.projectedCorner=
[{x:this.projectedleft+0,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+0},{x:this.projectedleft+this.projectedwidth,y:this.projectedtop+this.projectedheight},{x:this.projectedleft+0,y:this.projectedtop+this.projectedheight}];this.matrix=[[1,0,0],[0,1,0],[0,0,1]];this.invmatrix=[[1,0,0],[0,1,0],[0,0,1]];this.update()};r.prototype.getProjectedCornerBounds=function(){for(var a={left:99999,top:99999,right:-99999,bottom:-99999},b=0;4>b;b++)this.projectedCorner[b].x<
a.left&&(a.left=this.projectedCorner[b].x),this.projectedCorner[b].x>a.right&&(a.right=this.projectedCorner[b].x),this.projectedCorner[b].y<a.top&&(a.top=this.projectedCorner[b].y),this.projectedCorner[b].y>a.bottom&&(a.bottom=this.projectedCorner[b].y);a.width=a.right-a.left;a.height=a.bottom-a.top;return a};r.prototype.update=function(){function a(a,b){return k[a][b]}var b=1,d=1,f=0,h=0,b=this.projectedwidth/2,d=this.projectedheight/2,h=f=0,e=(this.projectedCorner[0].x-f)/b-1,c=(this.projectedCorner[0].y-
h)/d-1,g=(this.projectedCorner[1].x-f)/b-1,j=(this.projectedCorner[1].y-h)/d-1,l=(this.projectedCorner[3].x-f)/b-1,n=(this.projectedCorner[3].y-h)/d-1,b=(this.projectedCorner[2].x-f)/b-1,p=(this.projectedCorner[2].y-h)/d-1;console.log(e,c);console.log(g,j);console.log(l,n);console.log(b,p);var k=[[0,0,0],[0,0,0],[0,0,0]],u,s,m,d=g-b,h=l-b,f=e-g+b-l;u=j-p;s=n-p;m=c-j+p-n;0==f&&0==m?(k[0][0]=g-e,k[0][1]=b-g,k[0][2]=e,k[1][0]=j-c,k[1][1]=p-j,k[1][2]=c,k[2][0]=0,k[2][1]=0):(b=d*s-u*h,k[2][0]=0==b?1:(f*
s-m*h)/b,k[2][1]=0==b?1:(d*m-u*f)/b,k[0][0]=g-e+k[2][0]*g,k[0][1]=l-e+k[2][1]*l,k[0][2]=e,k[1][0]=j-c+k[2][0]*j,k[1][1]=n-c+k[2][1]*n,k[1][2]=c);k[2][2]=1;console.log("projection matrix",JSON.stringify(k));this.matrix=k;c=1/(+a(0,0)*(a(1,1)*a(2,2)-a(2,1)*a(1,2))-a(0,1)*(a(1,0)*a(2,2)-a(1,2)*a(2,0))+a(0,2)*(a(1,0)*a(2,1)-a(1,1)*a(2,0)));e=[[0,0,0],[0,0,0],[0,0,0]];g=(a(1,1)*a(2,2)-a(2,1)*a(1,2))*c;e[0][0]=g;g=-(a(0,1)*a(2,2)-a(0,2)*a(2,1))*c;e[0][1]=g;g=(a(0,1)*a(1,2)-a(0,2)*a(1,1))*c;e[0][2]=g;g=
-(a(1,0)*a(2,2)-a(1,2)*a(2,0))*c;e[1][0]=g;g=(a(0,0)*a(2,2)-a(0,2)*a(2,0))*c;e[1][1]=g;g=-(a(0,0)*a(1,2)-a(1,0)*a(0,2))*c;e[1][2]=g;g=(a(1,0)*a(2,1)-a(2,0)*a(1,1))*c;e[2][0]=g;g=-(a(0,0)*a(2,1)-a(2,0)*a(0,1))*c;e[2][1]=g;c*=a(0,0)*a(1,1)-a(1,0)*a(0,1);e[2][2]=c;console.log("inverted matrix",JSON.stringify(e));this.invmatrix=e};r.prototype.projectedToFlat=function(a,b){var d=this.invmatrix,f=0*this.projectedleft+0.5*this.projectedwidth,h=0*this.projectedtop+0.5*this.projectedheight,f=(a-1*f)/f,h=(b-
1*h)/h,e=d[2][0]*f+d[2][1]*h+d[2][2];return{x:this.flatwidth/1*(d[0][0]*f+d[0][1]*h+d[0][2])/e,y:this.flatheight/1*(d[1][0]*f+d[1][1]*h+d[1][2])/e}};r.prototype.flatToProjected=function(a,b){var d=this.matrix,f=this.projectedwidth/2,h=this.projectedheight/2,e=this.flatwidth/1,c=this.flatheight/1,e=(a-0*e)/e,c=(b-0*c)/c,g=d[2][0]*e+d[2][1]*c+d[2][2];return{x:f+f*(d[0][0]*e+d[0][1]*c+d[0][2])/g,y:h+h*(d[1][0]*e+d[1][1]*c+d[1][2])/g}};var m=function(a){a=a||{};this.projection=a.projection||null;this.projected=
a.projected||null;this.flat=a.flat||null;this.flatleft=a.flatleft||0;this.flattop=a.flattop||0;this.flatwidth=a.flatwidth||128;this.flatheight=a.flatheight||128;this.buffer=a.buffer||null;if(a.bufferwidth||a.bufferheight)this.bufferwidth=a.bufferwidth||128,this.bufferheight=a.bufferheight||128,this.bufferelement=document.createElement("canvas"),this.bufferelement.width=this.bufferwidth,this.bufferelement.height=this.bufferheight,this.buffer=this.bufferelement.getContext("2d"),a.bufferdebug&&document.body.appendChild(this.bufferelement);
null!=this.buffer&&(this.projection.flatwidth=this.bufferwidth,this.projection.flatheight=this.bufferheight,this.projection.update())};m.prototype.drawProjected=function(){var a=this.projection,b=a.getProjectedCornerBounds();if(null!=this.buffer){this.buffer.clearRect(0,0,this.bufferwidth,this.bufferheight);this.buffer.drawImage(this.flat,this.flatleft,this.flattop,this.flatwidth,this.flatheight,0,0,this.bufferwidth,this.bufferheight);for(var d=this.buffer.getImageData(0,0,this.bufferwidth,this.bufferheight),
f=this.projected.getImageData(0,0,a.projectedwidth,a.projectedheight),h=1,e=b.top;e<=b.bottom;e+=h)for(var c=b.left;c<=b.right;c+=h){var g=a.projectedToFlat(c,e),j=Math.round(g.x),l=Math.round(g.y),g=4*(e*a.projectedwidth+c);0<=j&&(0<=l&&j<this.bufferwidth&&l<this.bufferheight)&&(j=4*(l*this.bufferwidth+j),f.data[g+0]=d.data[j+0],f.data[g+1]=d.data[j+1],f.data[g+2]=d.data[j+2],f.data[g+3]=d.data[j+3])}}else{d=this.flat.getImageData(0,0,a.flatwidth,a.flatheight);f=this.projected.getImageData(0,0,a.projectedwidth,
a.projectedheight);h=1;for(e=b.top;e<=b.bottom;e+=h)for(c=b.left;c<=b.right;c+=h)g=a.projectedToFlat(c,e),j=Math.round(g.x),l=Math.round(g.y),g=4*(e*a.projectedwidth+c),0<=j&&(0<=l&&j<a.flatwidth&&l<a.flatheight)&&(j=4*(l*a.flatwidth+j),f.data[g+0]=d.data[j+0],f.data[g+1]=d.data[j+1],f.data[g+2]=d.data[j+2],f.data[g+3]=d.data[j+3])}this.projected.putImageData(f,0,0)};m.prototype.drawFlat=function(){var a=this.projection;this.flat.clearRect(0,0,a.flatwidth,a.flatheight);for(var b=this.projected.getImageData(0,
0,a.projectedwidth,a.projectedheight),d=this.flat.getImageData(0,0,a.flatwidth,a.flatheight),f=0;f<a.flatheight;f+=1)for(var h=0;h<a.flatwidth;h+=1){var e=a.flatToProjected(h,f),c=Math.round(e.x),g=Math.round(e.y),e=4*(f*a.flatwidth+h);0<=c&&(0<=g&&c<a.projectedwidth&&g<a.projectedheight)&&(c=4*(g*a.projectedwidth+c),d.data[e+0]=b.data[c+0],d.data[e+1]=b.data[c+1],d.data[e+2]=b.data[c+2],d.data[e+3]=b.data[c+3])}this.flat.putImageData(d,0,0)};m.prototype.cross=function(a,b,d,f,h){a.lineWidth=h;a.beginPath();
a.moveTo(b,d-f);a.lineTo(b,d+f);a.moveTo(b-f,d);a.lineTo(b+f,d);a.closePath();a.stroke()};m.prototype.drawProjectedDebug=function(a){a.strokeStyle="#f0f";for(var b=0;4>b;b++)this.cross(a,this.projection.projectedCorner[b].x,this.projection.projectedCorner[b].y,10,3)};m.prototype.drawFlatDebug=function(a){a.strokeStyle="#ff0";null!=this.buffer?(this.cross(a,this.flatleft,this.flattop,10,3),this.cross(a,this.flatleft+this.flatwidth,this.flattop,10,3),this.cross(a,this.flatleft+this.flatwidth,this.flattop+
this.flatheight,10,3),this.cross(a,this.flatleft,this.flattop+this.flatheight,10,3)):(this.cross(a,this.projection.flatleft,this.projection.flattop,10,3),this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop,10,3),this.cross(a,this.projection.flatleft+this.projection.flatwidth,this.projection.flattop+this.projection.flatheight,10,3),this.cross(a,this.projection.flatleft,this.projection.flattop+this.projection.flatheight,10,3))};glMatrixArrayType="undefined"!=typeof Float32Array?
Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;var t={identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},create:function(a){var b=new glMatrixArrayType(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b},ortho:function(a,b,d,f,h,e,c){c||(c=
t.create());var g=b-a,j=f-d,l=e-h;c[0]=2/g;c[1]=0;c[2]=0;c[3]=0;c[4]=0;c[5]=2/j;c[6]=0;c[7]=0;c[8]=0;c[9]=0;c[10]=-2/l;c[11]=0;c[12]=-(a+b)/g;c[13]=-(f+d)/j;c[14]=-(e+h)/l;c[15]=1;return c}};window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)};WebGLUnwarp=function(a){this.projection=a.projection||null;this.projected=a.projected||
null;this.flat=a.flat||null;this.flatleft=a.flatleft||0;this.flattop=a.flattop||0;this.flatwidth=a.flatwidth||1;this.flatheight=a.flatheight||1;this.texture=a.texture||null;this.cubeVertexIndexBuffer=this.cubeVertexTextureCoordBuffer=this.cubeVertexPositionBuffer=null;this.allocated=!1;this.resolution=a.resolution||15};WebGLUnwarp.prototype.createFragmentShader=function(a){var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,"precision mediump float;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nvoid main(void) {\n\tgl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}");
a.compileShader(b);return!a.getShaderParameter(b,a.COMPILE_STATUS)?(alert(a.getShaderInfoLog(b)),null):b};WebGLUnwarp.prototype.createVertexShader=function(a){var b=a.createShader(a.VERTEX_SHADER);a.shaderSource(b,"attribute vec3 aVertexPosition;\nattribute vec2 aTextureCoord;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec2 vTextureCoord;\nvoid main(void) {\n\tgl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\n\tvTextureCoord = aTextureCoord;\n}");a.compileShader(b);
return!a.getShaderParameter(b,a.COMPILE_STATUS)?(alert(a.getShaderInfoLog(b)),null):b};WebGLUnwarp.prototype.mapuv=function(a,b){return{u:a*this.flatwidth+this.flatleft,v:b*this.flatheight+this.flattop}};WebGLUnwarp.prototype.drawProjected=function(){var a=this.projected,b=this.projection;if(!this.allocated){this.cubeVertexPositionBuffer=a.createBuffer();this.cubeVertexTextureCoordBuffer=a.createBuffer();this.cubeVertexIndexBuffer=a.createBuffer();this.shaderProgram=a.createProgram();a.attachShader(this.shaderProgram,
this.createVertexShader(a));a.attachShader(this.shaderProgram,this.createFragmentShader(a));a.linkProgram(this.shaderProgram);if(!a.getProgramParameter(this.shaderProgram,a.LINK_STATUS)){alert("Could not link the shader program!");return}this.vertexPositionAttribute=a.getAttribLocation(this.shaderProgram,"aVertexPosition");this.textureCoordAttribute=a.getAttribLocation(this.shaderProgram,"aTextureCoord");this.pMatrixUniform=a.getUniformLocation(this.shaderProgram,"uPMatrix");this.mvMatrixUniform=
a.getUniformLocation(this.shaderProgram,"uMVMatrix");this.samplerUniform=a.getUniformLocation(this.shaderProgram,"uSampler");this.allocated=!0}for(var d=[],f=[],h=[],e=0,c=this.resolution,g=this.resolution,j=0;j<g;j++)for(var l=0;l<c;l++){var n=l/c,p=j/g,k=(l+1)/c,m=(j+1)/g,s=this.projection.flatToProjected(100*n,100*p),q=this.projection.flatToProjected(100*k,100*p),r=this.projection.flatToProjected(100*k,100*m),v=this.projection.flatToProjected(100*n,100*m);d.push(s.x);d.push(s.y);d.push(0);d.push(q.x);
d.push(q.y);d.push(0);d.push(r.x);d.push(r.y);d.push(0);d.push(v.x);d.push(v.y);d.push(0);s=this.mapuv(n,1-p);p=this.mapuv(k,1-p);k=this.mapuv(k,1-m);n=this.mapuv(n,1-m);f.push(s.u);f.push(s.v);f.push(p.u);f.push(p.v);f.push(k.u);f.push(k.v);f.push(n.u);f.push(n.v);h.push(4*e+0);h.push(4*e+1);h.push(4*e+2);h.push(4*e+0);h.push(4*e+2);h.push(4*e+3);e++}a.useProgram(this.shaderProgram);a.enableVertexAttribArray(this.vertexPositionAttribute);a.enableVertexAttribArray(this.textureCoordAttribute);a.bindBuffer(a.ARRAY_BUFFER,
this.cubeVertexPositionBuffer);a.bufferData(a.ARRAY_BUFFER,new Float32Array(d),a.STATIC_DRAW);this.cubeVertexPositionBuffer.itemSize=3;this.cubeVertexPositionBuffer.numItems=d.length/1;a.bindBuffer(a.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);this.cubeVertexTextureCoordBuffer.itemSize=2;this.cubeVertexTextureCoordBuffer.numItems=f.length/1;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);a.bufferData(a.ELEMENT_ARRAY_BUFFER,
new Uint16Array(h),a.STATIC_DRAW);this.cubeVertexIndexBuffer.itemSize=1;this.cubeVertexIndexBuffer.numItems=h.length/1;d=t.create();f=t.create();t.identity(f);t.ortho(0,b.projectedwidth,b.projectedheight,0,-1,1,f);t.identity(d);a.uniformMatrix4fv(this.pMatrixUniform,!1,f);a.uniformMatrix4fv(this.mvMatrixUniform,!1,d);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,this.texture);a.uniform1i(this.samplerUniform,0);a.bindBuffer(a.ARRAY_BUFFER,this.cubeVertexPositionBuffer);a.vertexAttribPointer(this.vertexPositionAttribute,
this.cubeVertexPositionBuffer.itemSize,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer);a.vertexAttribPointer(this.textureCoordAttribute,this.cubeVertexTextureCoordBuffer.itemSize,a.FLOAT,!1,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);a.drawElements(a.TRIANGLES,this.cubeVertexIndexBuffer.numItems,a.UNSIGNED_SHORT,0)};var q={};q.Unwarp=r;q.Warp=r;q.CanvasUnwarp=m;q.CanvasWarp=m;q.WebGLUnwarp=WebGLUnwarp;q.WebGLWarp=WebGLUnwarp;w.Project=q})(this);
