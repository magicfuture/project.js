<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<script src="../src/project.js" type="text/javascript"></script>
<script type="text/javascript">

	var videoelement;
	var textureelement;
    var warp1;
    var canvaswarp1;
    var gl;
    var webcam_ready = false;

	function onSuccess(stream) {
	    var videoSource;
	    if (window.webkitURL) {
			videoSource = window.webkitURL.createObjectURL(stream);
	    } else {
			videoSource = stream;
	    }
	    videoelement.autoplay = true;
	    videoelement.src = videoSource;

        setTimeout(function(){
    	    updateDynamicTexture();
            webcam_ready = true;
        }, 500);
	}

	function onError() {
	    alert('There has been a problem retreiving the streams - did you allow access?');
	}

	function initCamera() {
		if (navigator.webkitGetUserMedia) {
			navigator.webkitGetUserMedia({ video: true, audio: true }, onSuccess, onError);
		} else {
			alert('getUserMedia is not supported in this browser.');
		}
	}


    function initGL(canvas) {
        try {
            gl = canvas.getContext("experimental-webgl");
            gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
        } catch (e) {
        }
        if (!gl) {
            alert("Could not initialise WebGL, sorry :-(");
        }
    }

    function handleLoadedTexture(texture) {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, texture.image);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.bindTexture(gl.TEXTURE_2D, null);
    }

    var canvasTexture;

    function drawScene() {
        gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    }

    var flatctx;
    var flatelement;
    var canvasunwarp;

    function updateDynamicTexture() {
        var timeNow = new Date().getTime();
        gl.bindTexture(gl.TEXTURE_2D, canvasTexture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textureelement);
    }

    function initDynamicTexture() {
        canvasTexture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, canvasTexture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.bindTexture(gl.TEXTURE_2D, null);
    }

    var gridpos = -1;

    var grid = [
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],

        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
        [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
    ];

    function updateVideoInput() {
        texture = videocanvaselement.getContext('2d');
        if (webcam_ready) {
            texture.globalAlpha = 0.1;
            texture.drawImage(videoelement, 0, 0, 640, 480);
        } else {
            texture.clearRect(0, 0, 640, 480);
        }
    }

    function unwarpVideoInput() {

        unwarped = unwarpedelement.getContext('2d');
        canvasunwarp.drawFlat(unwarped);

        // debug stuff below
        if (mode != 3) {
            texture = videooverlayelement.getContext('2d');
            texture.clearRect(0, 0, 640, 480);
            canvasunwarp.drawProjectedDebug(texture, point, 16, 8);

            unwarped = unwarped2element.getContext('2d');
            canvasunwarp.drawFlat(unwarped);

            unwarped = unwarpedoverlayelement.getContext('2d');
            unwarped.clearRect(0, 0, 256, 128);
            generateRecogOverlay(unwarped, true, false);

            unwarped = unwarped2overlayelement.getContext('2d');
            unwarped.clearRect(0, 0, 256, 128);
            generateRecogOverlay(unwarped, true, true);
        }
    }

    function generateRecogOverlay(unwarped, debug, renderoutput) {
        if (debug) {
            unwarped.strokeStyle = '#f0f';
            unwarped.lineWidth = 1;
        }
        for(var r=0; r<8; r++) {
            for(var i=0; i<16; i++) {
                var x = 0 + 16 * i;
                var y = 0 + 16 * r;
                if (renderoutput) {
                    var v = grid[r][i];
                    unwarped.fillStyle = '#000';

                    if (i == gridpos) {
                        if (v > 1)
                            unwarped.fillStyle = '#fff';
                    } else {
                        // if (v == 1) unwarped.fillStyle = '#222';
                        if (v == 2) unwarped.fillStyle = '#330';
                        if (v == 3) unwarped.fillStyle = '#310';
                        if (v == 4) unwarped.fillStyle = '#131';
                        if (v == 5) unwarped.fillStyle = '#013';
                    }
                    unwarped.fillRect(x+2, y+2, 11, 11);

                    unwarped.fillStyle = '#fff';
                    unwarped.fillRect(x+7, y+7, 1, 1);

                }
                if (debug) {
                    unwarped.strokeRect(x+2, y+2, 12, 12);
                }
            }
        }
    }

    function updateAnalysis() {
        var ctx = unwarpedelement.getContext('2d');
        var img = ctx.getImageData(0, 0, 256, 128);
        for(var r=0; r<8; r++) {
            for(var i=0; i<16; i++) {
                var x = 0 + 16 * i;
                var y = 0 + 16 * r;
                var v = Math.round(Math.random() * 5);


                var ar = 0;
                var ag = 0;
                var ab = 0;
                for (var sy=0; sy<8; sy++){
                    for (var sx=0; sx<8; sx++){
                        var y2 = y - 4 + sy;
                        var x2 = x - 4 + sx;
                        var o = (y2 * 256 + x2) * 4;
                        ar += img.data[o+0];
                        ag += img.data[o+1];
                        ab += img.data[o+2];
                    }
                }

                ar /= 8*8;
                ag /= 8*8;
                ab /= 8*8;

                v = 0;
                if (ar > 128 && ag > 128 && ab > 128)
                    v = 1;
                else if (ar > 128 && ag > 128 && ab < 128)
                    v = 2;
                else if (ar > 128 && ag < 128 && ab < 128)
                    v = 3;
                else if (ar < 128 && ag > 128 && ab < 128)
                    v = 4;
                else if (ar < 128 && ag < 128 && ab > 128)
                    v = 5;

                if (i == gridpos && r > 5) v = (i % 4 == 0) ? 1 : 4;

                grid[r][i] = v;
            }
        }
    }

    function updateTexture() {

        texture = textureelement.getContext('2d');
        texture.fillStyle = '#000'
        texture.fillRect(0, 0, 256, 128);

        if (mode != 3) {
            texture.drawImage(unwarpedelement, 0, 0, 256, 128);
        }

        if (mode != 3) {
            texture.strokeStyle = '#f0f';
            texture.lineWidth = 3;
            texture.beginPath();
            texture.moveTo(0, 0);
            texture.lineTo(256, 0);
            texture.lineTo(256, 128);
            texture.lineTo(0, 128);
            texture.lineTo(0, 0);
            texture.lineTo(256, 128);
            texture.moveTo(256, 0);
            texture.lineTo(0, 128);
            texture.closePath();
            texture.stroke();

            for (var i=0; i<4; i++) {
                texture.strokeStyle = (i == point) ? '#ff0' : '#f0f';
                var x = (i == 1 || i == 2) ? 255 : 0;
                var y = (i == 2 || i == 3) ? 255 : 0;
                texture.strokeRect(x-10, y-10, 20, 20);
            }


        }

        generateRecogOverlay(texture, false, true);
    }

    var frameacc = 10;
    var tickindex = 0;

    function tick() {
        updateVideoInput();
        if (tickindex % frameacc == 0) {
            unwarpVideoInput();
            updateAnalysis();
        }
        tickindex ++;
        updateTexture();
        requestAnimFrame(tick);
        updateDynamicTexture();
        drawScene();
        canvaswarp1.drawProjected();
    }

    function getConfigValue(key, defaultvalue) {
        var cfgjson = localStorage['config'] || '{}';
        var cfg = JSON.parse(cfgjson);
        if (typeof(cfg[key]) !== 'undefined')
            return cfg[key];
        return defaultvalue;
    }

    function setConfigValue(key, value) {
        var cfgjson = localStorage['config'] || '{}';
        var cfg = JSON.parse(cfgjson);
        cfg[key] = value;
        localStorage['config'] = JSON.stringify(cfg);
    }

    function loadSettings() {
        warp2.projectedCorner[0].x = getConfigValue('unwarp_x0', 40);
        warp2.projectedCorner[0].y = getConfigValue('unwarp_y0', 10);
        warp2.projectedCorner[1].x = getConfigValue('unwarp_x1', 600);
        warp2.projectedCorner[1].y = getConfigValue('unwarp_y1', 50);
        warp2.projectedCorner[2].x = getConfigValue('unwarp_x2', 630);
        warp2.projectedCorner[2].y = getConfigValue('unwarp_y2', 470);
        warp2.projectedCorner[3].x = getConfigValue('unwarp_x3', 10);
        warp2.projectedCorner[3].y = getConfigValue('unwarp_y3', 470);

        warp1.projectedCorner[0].x = getConfigValue('proj_x0', 58);
        warp1.projectedCorner[0].y = getConfigValue('proj_y0', 40);
        warp1.projectedCorner[1].x = getConfigValue('proj_x1', 680);
        warp1.projectedCorner[1].y = getConfigValue('proj_y1', 20);
        warp1.projectedCorner[2].x = getConfigValue('proj_x2', 780);
        warp1.projectedCorner[2].y = getConfigValue('proj_y2', 490);
        warp1.projectedCorner[3].x = getConfigValue('proj_x3', 5);
        warp1.projectedCorner[3].y = getConfigValue('proj_y3', 590);
    }

    function saveSettings() {
        setConfigValue('unwarp_x0', warp2.projectedCorner[0].x);
        setConfigValue('unwarp_y0', warp2.projectedCorner[0].y);
        setConfigValue('unwarp_x1', warp2.projectedCorner[1].x);
        setConfigValue('unwarp_y1', warp2.projectedCorner[1].y);
        setConfigValue('unwarp_x2', warp2.projectedCorner[2].x);
        setConfigValue('unwarp_y2', warp2.projectedCorner[2].y);
        setConfigValue('unwarp_x3', warp2.projectedCorner[3].x);
        setConfigValue('unwarp_y3', warp2.projectedCorner[3].y);

        setConfigValue('proj_x0', warp1.projectedCorner[0].x);
        setConfigValue('proj_y0', warp1.projectedCorner[0].y);
        setConfigValue('proj_x1', warp1.projectedCorner[1].x);
        setConfigValue('proj_y1', warp1.projectedCorner[1].y);
        setConfigValue('proj_x2', warp1.projectedCorner[2].x);
        setConfigValue('proj_y2', warp1.projectedCorner[2].y);
        setConfigValue('proj_x3', warp1.projectedCorner[3].x);
        setConfigValue('proj_y3', warp1.projectedCorner[3].y);
    }

    var savetimer = 0;

    function delayedSaveSettings () {
        if (savetimer != 0) clearTimeout(savetimer);
        savetimer = setTimeout(saveSettings, 1000);
    }

    function initWarp() {

        warp2 = new Project.Warp({
            forward: true,
            projectedwidth: 640,
            projectedheight: 480,
            flatwidth: 256,
            flatheight: 128,
        });

        warp1 = new Project.Warp({
            forward: true,
            projectedwidth: 800,
            projectedheight: 600,
            flatwidth: 100,
            flatheight: 100,
        });

        loadSettings();

        warp2.update();

        warp1.update();

        canvasunwarp = new Project.CanvasUnwarp({
            projection: warp2,
            projected: videocanvaselement.getContext('2d'),
            flat: unwarpedelement.getContext('2d')
        });

        canvaswarp1 = new Project.WebGLUnwarp({
            projection: warp1,
            flat: flatelement,
            flatleft: 0,
            flattop: 0,
            flatwidth: 1.0,
            flatheight: 1.0,
            projected: gl,
            texture: canvasTexture
        });
    }

    var mode = 0;
    var point = 0;

    function setMode(n) {
        if (n < 0) n = 0;
        if (n > 3) n = 3;
        mode = n;
        document.getElementById('overlaywrapper').style.display = (n != 3) ? 'block' : 'none';
        document.getElementById('screen1').style.display = (n == 0) ? 'block' : 'none';
        document.getElementById('screen2').style.display = (n == 1) ? 'block' : 'none';
        document.getElementById('screen3').style.display = (n == 2) ? 'block' : 'none';
    }

    function setPoint(n) {
        if (n < 0) n = 0;
        if (n > 3) n = 3;
        point = n;
    }

    function moveCursor(dx, dy) {
        if (mode == 0 || mode == 1) {
            warp2.projectedCorner[point].x += dx;
            warp2.projectedCorner[point].y += dy;
            warp2.update();
            delayedSaveSettings();
        }
        if (mode == 2 || mode == 3) {
            warp1.projectedCorner[point].x += dx;
            warp1.projectedCorner[point].y += dy;
            warp1.update();
            delayedSaveSettings();
        }
    }

    function keypress(evt) {
        console.log('key event', evt, evt.keyCode);

        if (evt.keyCode == 112) setMode(0); // F1
        if (evt.keyCode == 113) setMode(1); // F2
        if (evt.keyCode == 114) setMode(2); // F3
        if (evt.keyCode == 115) setMode(3); // F4
        if (evt.keyCode == 116) setMode(4); // F5
        if (evt.keyCode == 117) setMode(5); // F6

        if (evt.keyCode == 49) setPoint(0); // 1
        if (evt.keyCode == 50) setPoint(1); // 2
        if (evt.keyCode == 51) setPoint(2); // 3
        if (evt.keyCode == 52) setPoint(3); // 4

        var delta = (evt.shiftKey || evt.altKey) ? 10 : 1;

        if (evt.keyCode == 37) moveCursor(-delta, 0); // left
        if (evt.keyCode == 39) moveCursor(delta, 0); // right
        if (evt.keyCode == 38) moveCursor(0, -delta); // up
        if (evt.keyCode == 40) moveCursor(0, delta); // down

        if (evt.keyCode == 67) {
            // C - clear
        }

        if (evt.keyCode == 67) {
            // M - mode
        }

        if (evt.keyCode == 32) {
            // space
        }

        // 65 83 68
        if (evt.keyCode == 65) sound('drum1');
        if (evt.keyCode == 83) sound('drum2');
        if (evt.keyCode == 68) sound('drum3');

        evt.stopPropagation();
        return false;
    }

    var drums = {};

    function sound(nam) {
        // var el = drums[nam];
        var el = new Audio();
        el.src = drums[nam];
        // var el = document.getElementById(nam);
        // el.loop = true;
        //el.pause();
        // el.play();
        //    el.currentTime = 0;
        // el.autoplay = true;
        // el.load();
        document.body.appendChild(el);
        el.play();
        setTimeout(function() {
            document.body.removeChild(el);
        }, 1000);
        /*
        el.loop = false;
        */
    }

    function beat() {

        gridpos ++;
        if (gridpos > 15)
            gridpos = 0;


        if (grid[0][gridpos] > 1 || grid[1][gridpos] > 1) sound('drum1');
        if (grid[2][gridpos] > 1 || grid[3][gridpos] > 1) sound('drum2');
        if (grid[4][gridpos] > 1 || grid[5][gridpos] > 1) sound('drum3');
    }

    function loadDrum(url) {
        var el = new Audio(url);
        el.controls = true;
        el.addEventListener('ended', function(e) {
            el.currentTime = 0;
            // el.load();
        });
        var pel = document.getElementById('screen1');
        // pel.appendChild(el);
        return el;
    }

    function init() {

        drums['drum1'] = 'kick.mp3';
        drums['drum2'] = 'hat.mp3';
        drums['drum3'] = 'snare.mp3';

        textureelement = document.getElementById('texture');
        unwarpedelement = document.getElementById('unwarped');
        unwarpedoverlayelement = document.getElementById('unwarpedoverlay');
        unwarped2element = document.getElementById('unwarped2');
        unwarped2overlayelement = document.getElementById('unwarpedoverlay2');
    	videoelement = document.getElementById('webcam');
        videocanvaselement = document.getElementById('webcamcanvas');
        videooverlayelement = document.getElementById('webcamoverlay');

        var canvas = document.getElementById("webgl");
        initGL(canvas);
        initDynamicTexture();
        initWarp();

        gl.clearColor(0.0, 0.0, 0.0, 1.0);
        gl.enable(gl.DEPTH_TEST);

        window.addEventListener('keydown', keypress, true);
        setMode(0);
        setPoint(0);
    	setTimeout(initCamera, 100);
        tick();

        setInterval(beat, 250 * 60.0 / 125.0);
    }

</script>
<style type="text/css">

html, body { margin: 0; padding: 0; overflow: hidden; }

canvas#webgl {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 100%;
    height: 100%;
}

div#overlaywrapper {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 50%;
    height: 50%;
    z-index: 9999;
}

div.overlay {
    position: absolute;
    right: -540px;
    width: 1000px;
    top: 40px;
    padding: 40px;
    background-color: rgba(255,255,255,0.66);
}

div.overlay h2 {
    margin: 0;
    color: #000;
    font-weight: bold
}

div.videoplaceholder {
    height: 480px;
    position: relative;
}

div.videoplaceholder video#webcam,
div.videoplaceholder canvas#webcamcanvas,
div.videoplaceholder canvas#webcamoverlay {
    position: absolute;
    left: 0px;
    top: 0px;
}

div.videoplaceholder canvas#unwarped,
div.videoplaceholder canvas#unwarpedoverlay {
    position: absolute;
    left: 660px;
}

div.videoplaceholder canvas#unwarped2,
div.videoplaceholder canvas#unwarpedoverlay2 {
    position: absolute;
    left: 0px;
}

div.videoplaceholder canvas#texture {
    position: absolute;
    left: 280px;
}

div.hidden { display: none; }

</style>
</head>
<body onLoad="init()">

<canvas id="webgl" width="800" height="600" style="background-color:#000;"></canvas>

<div id="overlaywrapper">
    <div class="overlay">
        <div id="screen1">
            <h2>Camera input</h2>
            <div class="videoplaceholder">
                <canvas id="webcamcanvas" width="640" height="480" style="background-color:#222;"></canvas>
                <canvas id="webcamoverlay" width="640" height="480"></canvas>
                <canvas id="unwarped" width="256" height="128" style="background-color:#222;"></canvas>
                <canvas id="unwarpedoverlay" width="256" height="128"></canvas>
            </div>
            <p>
                Use arrow keys to move corners, 1 to 4 selects corner.
            </p>
        </div>
        <div id="screen2">
            <h2>Analyse input</h2>
            <p>Nothing is done here yet</p>
            <div class="videoplaceholder">
                <canvas id="unwarped2" width="256" height="128" style="background-color:#222;"></canvas>
                <canvas id="unwarpedoverlay2" width="256" height="128"></canvas>
                <canvas id="texture" width="256" height="128" style="background-color:#222;"></canvas>
            </div>
        </div>
        <div id="screen3">
            <h2>Project output</h2>
            <p>Use arrow keys to move corners, 1 to 4 selects corner.</p>
        </div>
        <p class="kbd">
            Keyboard help:<br/>
            F1..F3: Edit mode.<br/>
            F4: Presentation mode.<br/>
            Arrow keys: Move corner<br/>
        </p>
    </div>
</div>
<div class="hidden">
    <video id="webcam" width="640" height="480" style="background-color:#222;"></video><br/>
</div>

</body>
</html>